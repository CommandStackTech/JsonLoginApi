name: Deploy (.NET -> EC2)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read

env:
  APP_NAME: dotnetapp
  APP_ROOT: /var/www/dotnetapp
  CONFIGURATION: Release
  DOTNET_VERSION: "8.0.x"
  PROJECT_PATH: JsonLoginApi.csproj

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      - name: Build
        run: dotnet build "${{ env.PROJECT_PATH }}" -c "${{ env.CONFIGURATION }}" --no-restore

      - name: Publish
        run: |
          rm -rf publish
          dotnet publish "${{ env.PROJECT_PATH }}" -c "${{ env.CONFIGURATION }}" --no-build -o publish

      - name: Create artifact (app.tgz)
        run: |
          tar -czf app.tgz -C publish .
          ls -lah app.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-tgz
          path: app.tgz
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-tgz

      - name: Debug secrets present (safe)
        shell: bash
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          set -euo pipefail
          echo "EC2_HOST set?  $([ -n "${EC2_HOST:-}" ] && echo YES || echo NO)"
          echo "EC2_USER set?  $([ -n "${EC2_USER:-}" ] && echo YES || echo NO)"
          echo "EC2_SSH_KEY set? $([ -n "${EC2_SSH_KEY:-}" ] && echo YES || echo NO)"
          echo "EC2_SSH_KEY bytes: ${#EC2_SSH_KEY}"

      - name: Setup SSH (pinpoint)
        shell: bash
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euo pipefail
          set -x

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          if [ -z "${EC2_SSH_KEY:-}" ]; then
            echo "ERROR: EC2_SSH_KEY secret is empty or not available to this workflow."
            exit 1
          fi

          printf "%s" "$EC2_SSH_KEY" > ~/.ssh/id_rsa
          tr -d '\r' < ~/.ssh/id_rsa > ~/.ssh/id_rsa.clean && mv ~/.ssh/id_rsa.clean ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          ssh -i ~/.ssh/id_rsa -o BatchMode=yes -o StrictHostKeyChecking=yes \
            "${{ secrets.EC2_USER }}@$EC2_HOST" "echo SSH_OK"

      - name: Upload app.tgz to EC2
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes \
            app.tgz "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/app.tgz"

      - name: Atomic deploy (releases + symlink + restart)
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" << 'SSH'
            set -euo pipefail

            APP_ROOT="/var/www/dotnetapp"
            TS="$(date +%Y%m%d%H%M%S)"
            RELEASE_DIR="$APP_ROOT/releases/$TS"

            sudo mkdir -p "$RELEASE_DIR"
            sudo tar -xzf /tmp/app.tgz -C "$RELEASE_DIR"
            sudo rm -f /tmp/app.tgz

            sudo ln -sfn "$RELEASE_DIR" "$APP_ROOT/current"
            sudo systemctl daemon-reload || true
            sudo systemctl restart dotnetapp
            sudo systemctl is-active --quiet dotnetapp
          SSH
